# RabbitMQ

### 消息队列有什么用

- 通过异步处理减小系统响应时间
- 削峰/限流：在高并发场景下，系统将消息放到消息队列中，交给后台慢慢处理
- 降低模块之间的耦合性
- 可以实现分布式事务

### RabbitMQ的核心概念

- 生产者和消费者
- 消息队列：存放消息的数据结构
- 交换机：负责将消息路由到消息队列

### 交换机有哪些类型

- fanout：消息会转发到所有绑定的队列上
- direct：只有RoutingKey和BindingKey完全一样，才会转发到队列
- topic：RoutingKey和BindingKey位以"."分隔的字符串，可以用“*”代替一个分隔字符串，用“#”代替多个分隔字符串，从而实现模糊匹配
- headers：根据消息中的headers属性信息来进行匹配，该方式性能差

### AMQP是什么

一个消息队列协议，RabbitMQ支持并实现了该协议，该协议分为三层

- Moudle Layer：最高层，定义一些客户端使用的命令
- Session Layer：中间层，负责客户端发送命令给服务端，服务端再返回结果给客户端，提供可靠性同步机制和错误处理
- Transport Layer：最底层，主要传输二进制数据流

三大组件：

- 交换机
- 队列
- 绑定

### 什么是死信队列，如何导致

当一个消息变成死信后，会将该消息发送到死信交换机，与该交换机绑定的队列就是死信队列

导致死信的几种原因：

- 消息被拒
- 消息TTL过期
- 消息队列满了

### 什么是延迟队列？RabbitMQ 怎么实现延迟队列？

延迟队列指的是，当消息被发送到队列时，无法立即取出，而是过一段设定的时间后才能被取出；有两种实现方式：

- 利用死信队列：设定TTL时间，到时间后被发送到死信队列，消费者从死信队列中消费信息
- 使用插件

### RabbitMQ 有哪些工作模式？

- 简单模式：没有交换机，一对一
- 工作模式：没有交换机，一对多，争抢消息
- 发布/订阅模式：有交换机，且fanout类型
- 路由模式：有交换机，且directl类型
- 主题模式：有交换机，且topic类型

### RabbitMQ消息如何传输

基于TCP连接，使用信道进行传输。信道是建立在TCP上的虚拟连接，且数量没有限制。

### 如何保证消息可靠性

- 生产者到消息队列：事务或者confirm机制
- 消息队列内部：持久化、集群、镜像模式
- 消息队列到消费者：basicAck 机制，死信队列，消息补偿机制

###  如何保证 RabbitMQ 消息的顺序性

- 拆分许多的队列，每个队列对应一个消费者，这样每个队列中都是保证顺序的
- 就用一个队列和一个消费者，消费者可以使用多线程处理，然后在代码层面维护顺序

### 如何保证RabbitMQ高可用

采取集群，有两种模式：

- 普通模式：队列本身不进行同步，配置信息会同步，当访问某个节点式，可以找到对应队列所在的节点进行转发
- 镜像模式：队列本身进行了同步，访问任意节点都能进行完整的操作，操作完要进行所有节点的同步，对网络性能要求较高